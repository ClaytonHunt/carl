$schema: "http://json-schema.org/draft-07/schema#"
title: "CARL Session File Schema"
description: "Schema for session-YYYY-MM-DD-{user}.carl - Daily session tracking with optimized logging. Supports both verbose format (full YAML) and compact format (pipe-delimited work periods only) for 90-95% size reduction."
type: object
additionalProperties: false

required:
  - developer
  - date
  - session_summary
  
# Either verbose work_periods OR compact_work_periods required
anyOf:
  - required: ["work_periods", "agent_performance", "command_metrics", "active_context_carryover", "cleanup_log"]
  - required: ["compact_work_periods"]

properties:
  developer:
    type: string
    minLength: 1
    description: "Developer name from git config user.name"
    
  date:
    type: string
    pattern: "^\\d{4}-\\d{2}-\\d{2}$"
    description: "Session date in YYYY-MM-DD format"
    
  session_summary:
    type: object
    additionalProperties: false
    required: ["start_time"]
    properties:
      start_time:
        type: string
        pattern: "^\\d{2}:\\d{2}:\\d{2}Z$"
        description: "Session start time in HH:MM:SSZ format"
      end_time:
        type: string
        pattern: "^\\d{2}:\\d{2}:\\d{2}Z$"
        description: "Session end time in HH:MM:SSZ format (optional)"
    description: "High-level session timing information"
    
  work_periods:
    type: array
    items:
      type: object
      additionalProperties: false
      required: ["start", "end", "focus", "context", "commits"]
      properties:
        start:
          type: string
          pattern: "^\\d{2}:\\d{2}:\\d{2}Z$"
          description: "Work period start time"
        end:
          type: string
          pattern: "^\\d{2}:\\d{2}:\\d{2}Z$"
          description: "Work period end time"
        focus:
          type: string
          pattern: "^[a-z][a-z0-9_-]*\\.(epic|feature|story|tech)\\.carl$"
          description: "CARL file being worked on"
        context:
          type: string
          minLength: 1
          description: "Work context description"
        commits:
          type: array
          items:
            type: string
            pattern: "^[a-f0-9]{7,40}$"
          description: "Git commit hashes during this period"
    description: "Detailed work periods"
    
  compact_work_periods:
    type: array
    items:
      type: string
      pattern: "^[a-z][a-z0-9_-]*\\|\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z\\|\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
      description: "Compact format: work_id|start_timestamp|end_timestamp"
    description: "Work periods in compact pipe-delimited format for maximum efficiency (90-95% size reduction)"
    
  agent_performance:
    type: array
    items:
      type: object
      additionalProperties: false
      required: ["agent", "invocation_time", "duration", "task", "success", "context_tokens"]
      properties:
        agent:
          type: string
          pattern: "^[a-z][a-z0-9_-]*$"
          description: "Agent name"
        invocation_time:
          type: string
          pattern: "^\\d{2}:\\d{2}:\\d{2}Z$"
          description: "Agent invocation time"
        duration:
          type: string
          pattern: "^\\d+(\\.\\d+)?s$"
          description: "Execution duration in seconds"
        task:
          type: string
          minLength: 1
          description: "Task description"
        success:
          type: boolean
          description: "Whether the agent succeeded"
        context_tokens:
          type: integer
          minimum: 0
          description: "Number of context tokens used"
    description: "Agent performance metrics"
    
  command_metrics:
    type: array
    items:
      type: object
      additionalProperties: false
      required: ["command", "execution_time", "success", "agents_used"]
      properties:
        command:
          type: string
          pattern: "^/carl:(analyze|plan|task|status)\\b.*$"
          description: "CARL command executed"
        execution_time:
          type: string
          pattern: "^\\d+(\\.\\d+)?s$"
          description: "Command execution time"
        success:
          type: boolean
          description: "Whether the command succeeded"
        agents_used:
          type: array
          items:
            type: string
            pattern: "^[a-z][a-z0-9_-]*$"
          description: "List of agents used by the command"
    description: "CARL command execution metrics"
    
  active_context_carryover:
    type: object
    description: "Context preserved for next day's session"
    
  cleanup_log:
    type: array
    items:
      type: object
      additionalProperties: false
      required: ["cleaned_date", "retention_period"]
      properties:
        cleaned_date:
          type: string
          pattern: "^\\d{4}-\\d{2}-\\d{2}$"
          description: "Date when cleanup occurred"
        retention_period:
          type: string
          enum: ["7_days", "30_days", "90_days", "1_year"]
          description: "Retention period that triggered cleanup"
    description: "Session cleanup activity log"